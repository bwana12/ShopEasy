
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopEasy | Malawi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #e42c64; --secondary: #2a9dcc; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        
        header { background: white; padding: 15px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { color: var(--primary); font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 10px; }
        .search-bar { display: flex; background: #eee; border-radius: 25px; padding: 5px 15px; align-items: center; }
        .search-bar input { border: none; background: none; padding: 10px; width: 100%; outline: none; }

        /* Professional Smaller Grid */
        .product-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
            padding: 10px; 
        }
        .p-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .p-card img { width: 100%; height: 120px; object-fit: cover; }
        .p-info { padding: 8px; }
        .p-name { font-size: 13px; font-weight: 600; height: 34px; overflow: hidden; margin-bottom: 4px; }
        .p-price { color: var(--primary); font-weight: bold; font-size: 14px; }
        .add-btn { background: var(--secondary); color: white; border: none; width: 100%; padding: 7px; border-radius: 5px; margin-top: 5px; cursor: pointer; font-size: 12px; }

        /* Cart Overlay */
        #cart-modal { position: fixed; top: 0; right: -100%; width: 100%; height: 100%; background: white; z-index: 1000; transition: 0.4s; padding: 20px; box-sizing: border-box; }
        #cart-modal.active { right: 0; }
        .cart-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .cart-item-info { flex-grow: 1; }
        
        /* Quantity Controls */
        .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .qty-btn { background: #eee; border: none; width: 25px; height: 25px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .del-item { color: #ff4d4d; border: none; background: none; padding: 10px; cursor: pointer; font-size: 16px; }

        .wa-btn { background: #25D366; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; margin-top: 15px; }
        .cart-float { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; width: 55px; height: 55px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 99; border: none; }
        .badge { position: absolute; top: 0; right: 0; background: black; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">ShopEasy</div>
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search..." onkeyup="search()">
        </div>
    </header>

    <div class="product-grid" id="productList"></div>

    <button class="cart-float" onclick="toggleCart()">
        <i class="fas fa-shopping-cart"></i>
        <span class="badge" id="cartCount">0</span>
    </button>

    <div id="cart-modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Your Cart</h2>
            <button onclick="toggleCart()" style="border:none; background:none; font-size:24px;">&times;</button>
        </div>
        <div id="cartItems" style="max-height: 60vh; overflow-y: auto;"></div>
        <div style="margin-top: 20px;">
            <h3>Total: MK <span id="cartTotal">0</span></h3>
            <input type="text" id="custName" placeholder="Your Name" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px;">
            <button class="wa-btn" onclick="sendWhatsApp()">Order on WhatsApp</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwhyU5BrtjRhy-45rd5oYfzGO8abehUiM",
            authDomain: "shopeasy-14890.firebaseapp.com",
            projectId: "shopeasy-14890",
            storageBucket: "shopeasy-14890.firebasestorage.app",
            messagingSenderId: "45827037951",
            appId: "1:45827037951:web:545d41703780fa51018aca"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let products = [];
        let cart = [];

        onSnapshot(collection(db, "products"), snap => {
            products = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            render(products);
        });

        function render(list) {
            document.getElementById('productList').innerHTML = list.map(p => `
                <div class="p-card">
                    <img src="${p.image}">
                    <div class="p-info">
                        <div class="p-name">${p.name}</div>
                        <div class="p-price">MK ${p.price.toLocaleString()}</div>
                        <button class="add-btn" onclick="addToCart('${p.id}')">Add to Cart</button>
                    </div>
                </div>
            `).join('');
        }

        window.addToCart = (id) => {
            const existing = cart.find(item => item.id === id);
            if(existing) {
                existing.qty++;
            } else {
                const product = products.find(p => p.id === id);
                cart.push({...product, qty: 1});
            }
            updateCart();
        };

        window.changeQty = (index, delta) => {
            cart[index].qty += delta;
            if(cart[index].qty < 1) cart.splice(index, 1);
            updateCart();
        };

        window.removeFromCart = (index) => {
            cart.splice(index, 1);
            updateCart();
        };

        function updateCart() {
            const count = cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cartCount').innerText = count;
            
            let total = 0;
            document.getElementById('cartItems').innerHTML = cart.map((item, i) => {
                total += (item.price * item.qty);
                return `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <b>${item.name}</b><br>
                        MK ${(item.price * item.qty).toLocaleString()}
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="changeQty(${i}, -1)">-</button>
                            <span>${item.qty}</span>
                            <button class="qty-btn" onclick="changeQty(${i}, 1)">+</button>
                        </div>
                    </div>
                    <button class="del-item" onclick="removeFromCart(${i})"><i class="fas fa-trash"></i></button>
                </div>`;
            }).join('');
            document.getElementById('cartTotal').innerText = total.toLocaleString();
        }

        window.toggleCart = () => document.getElementById('cart-modal').classList.toggle('active');

        window.search = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            render(products.filter(p => p.name.toLowerCase().includes(term)));
        };

        window.sendWhatsApp = async () => {
            const name = document.getElementById('custName').value;
            if(!name || cart.length === 0) return alert("Fill name and add items!");

            let total = 0;
            const items = cart.map(i => {
                total += (i.price * i.qty);
                return `- ${i.name} (x${i.qty})`;
            }).join("%0A");

            const msg = `*Order from ${name}*%0A${items}%0A*Total:* MK ${total}`;
            
            await addDoc(collection(db, "orders"), {
                customerName: name,
                items: cart,
                total: total,
                status: "pending",
                timestamp: Date.now()
            });

            window.open(`https://wa.me/265999000000?text=${msg}`); 
        };
    </script>
</body>
</html>
