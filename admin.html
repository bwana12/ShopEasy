<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopEasy | Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #e42c64; --secondary: #2a9dcc; --bg: #f0f2f5; --success: #28a745; --danger: #dc3545; --warning: #fd7e14; }
        * { box-sizing: border-box; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; padding: 20px; color: #333; margin: 0; }
        
        /* Login Screen Overlay */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px;
        }
        .login-card .logo { font-size: 28px; font-weight: bold; color: var(--primary); margin-bottom: 20px; }
        
        /* Google Sign-In Button Style */
        .btn-google {
            background: white; color: #444; border: 1px solid #ddd; padding: 12px 20px;
            border-radius: 8px; font-weight: bold; cursor: pointer; display: flex;
            align-items: center; justify-content: center; gap: 10px; width: 100%;
            transition: 0.3s;
        }
        .btn-google:hover { background: #f8f8f8; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Order Notification Toast */
        #order-toast {
            position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white;
            padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none; z-index: 10000; animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Dashboard Header */
        header { max-width: 1200px; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: stretch; flex-wrap: wrap; gap: 15px; }
        
        .stats-container { display: flex; gap: 15px; flex-grow: 1; flex-wrap: wrap; align-items: flex-start; }
        .stat-card { color: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex: 1; min-width: 200px; text-align: center; position: relative; }
        .rev-bg { background: var(--success); }
        .prof-bg { background: var(--secondary); }
        .best-bg { background: #6f42c1; }
        .stat-card h1 { margin: 5px 0; font-size: 22px; }
        .btn-clear { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; margin-top: 5px; }
        
        .btn-summary { background: #f39c12; color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px; height: fit-content; align-self: center; }
        
        .restock-alert { background: var(--danger); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; display: none; align-items: center; gap: 8px; height: fit-content; align-self: center; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .btn-logout { background: white; color: var(--danger); border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px; height: fit-content; align-self: center; }
        .btn-export { background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; color: #444; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--secondary); margin-bottom: 30px; transition: 0.3s; }
        .edit-mode-active { border-top-color: var(--primary); background: #fffdfd; }
        h2 { margin-bottom: 20px; font-size: 1.2rem; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .btn-post { background: var(--secondary); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-cancel { background: #666; color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; margin-top: 10px; font-size: 14px; display: none; }

        .bulk-toggle-container { display: flex; align-items: center; gap: 10px; margin: 10px 0; font-size: 14px; font-weight: bold; color: var(--secondary); }
        .bulk-toggle-container input { width: auto; margin: 0; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1200px; margin: 0 auto; }
        @media (max-width: 850px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .filter-bar input { margin: 0; padding: 8px 12px; flex: 1; }

        .scroll-section { max-height: 700px; overflow-y: auto; padding-right: 10px; }
        .section-title { margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }

        .inv-item { background: white; display: flex; align-items: center; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; gap: 15px; transition: 0.3s; }
        .low-stock { border-left: 5px solid var(--danger); background: #fff5f5; }
        .warning-stock { border-left: 5px solid var(--warning); background: #fff9f2; }
        .inv-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; }
        .inv-info { flex-grow: 1; }
        .inv-info b { font-size: 14px; display: block; }
        .stock-input { width: 70px !important; margin: 0 !important; padding: 5px !important; text-align: center; font-weight: bold; border-color: var(--secondary); }
        
        /* Bulk Edit Enhancements */
        .bulk-adjust-btn { background: #34495e; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .bulk-save-btn { background: var(--success); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; display: none; }
        .bulk-input-field { width: 85px !important; margin: 0 !important; border-color: var(--secondary) !important; font-size: 12px !important; padding: 5px !important; }

        .order { background: white; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--secondary); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .delivered { opacity: 0.7; border-left-color: #888; background: #f9f9f9; border-left-style: dashed; }
        .badge-bulk { background: #6f42c1; color: white; font-size: 10px; padding: 3px 8px; border-radius: 5px; position: absolute; top: 10px; right: 10px; font-weight: bold; }
        .mark-btn { background: #25D366; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 10px; }
        
        .action-btns { display: flex; gap: 10px; }
        .btn-del { color: #ff4d4d; border: none; background: none; cursor: pointer; font-size: 16px; }
        .btn-edit { color: var(--secondary); border: none; background: none; cursor: pointer; font-size: 16px; }

        .row-flex { display: flex; gap: 10px; }
        .badge-low { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .badge-warning { background: var(--warning); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .badge-sold { background: #333; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="order-toast"><i class="fas fa-bell"></i> ðŸ”” New Order Received!</div>

    <div id="login-screen">
        <div class="login-card">
            <div class="logo">ShopEasy Admin</div>
            <p style="margin-bottom: 20px; font-size: 14px; color: #666;">Secure access for store owner only.</p>
            <button class="btn-google" onclick="loginAdmin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Sign in with Google
            </button>
            <p id="login-error" style="color:var(--danger); font-size:12px; margin-top:10px; display:none;">Unauthorized access!</p>
        </div>
    </div>

    <div id="admin-dashboard" style="display: none;">
        <header>
            <div class="stats-container">
                <div class="stat-card rev-bg">
                    <p style="margin:0; font-size: 11px; opacity: 0.9;">TOTAL SALES</p>
                    <h1 id="totalRevenue">MK 0</h1>
                    <button class="btn-clear" onclick="clearOrders()"><i class="fas fa-eraser"></i> Reset</button>
                </div>
                <div class="stat-card prof-bg">
                    <p style="margin:0; font-size: 11px; opacity: 0.9;">EST. PROFIT</p>
                    <h1 id="totalProfit">MK 0</h1>
                </div>
                <div class="stat-card best-bg">
                    <p style="margin:0; font-size: 11px; opacity: 0.9;">TOP SELLER</p>
                    <h1 id="topProduct" style="font-size: 16px; margin-top: 8px;">None</h1>
                </div>
                <button class="restock-alert" id="restockBtn" onclick="filterOutStock()"><i class="fas fa-exclamation-triangle"></i> <span id="outCount">0</span> Needs Restock</button>
                <button class="btn-summary" onclick="showDailySummary()"><i class="fas fa-calendar-day"></i> Today</button>
                <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <div class="dashboard-grid">
            <div>
                <div class="card" id="formCard">
                    <h2 id="formTitle">ðŸš€ Post New Product</h2>
                    <input type="text" id="name" placeholder="Product Name">
                    <div class="bulk-toggle-container">
                        <input type="checkbox" id="bulkToggle" onchange="toggleBulkPrice()"> 
                        <label for="bulkToggle">Apply Bulk Price to Sale Price?</label>
                    </div>
                    <div class="row-flex">
                        <input type="number" id="price" placeholder="Sale Price (MK)" oninput="calcBulkFromPercent()">
                        <input type="number" id="costPrice" placeholder="Cost Price (MK)">
                    </div>
                    <div class="row-flex">
                        <input type="number" id="bulkPercent" placeholder="Bulk Disc %" oninput="calcBulkFromPercent()">
                        <input type="number" id="bulkPrice" placeholder="Bulk Price (MK)">
                        <input type="number" id="stock" placeholder="Stock Qty">
                    </div>
                    <div class="row-flex">
                        <input type="number" id="alertLevel" placeholder="Alert Level (Default: 3)">
                        <select id="cat">
                            <option value="Electronics">Electronics</option>
                            <option value="Fashion">Fashion</option>
                            <option value="Home">Home</option>
                            <option value="Beauty">Beauty</option>
                        </select>
                    </div>
                    <input type="text" id="img" placeholder="Image Link">
                    <textarea id="desc" placeholder="Details..."></textarea>
                    <button class="btn-post" id="submitBtn" onclick="upload()">Publish Product</button>
                    <button class="btn-cancel" id="cancelBtn" onclick="resetForm()">Cancel Editing</button>
                </div>

                <h3 class="section-title">
                    <span><i class="fas fa-shopping-bag"></i> Orders</span>
                    <button class="btn-export" onclick="exportOrders()"><i class="fas fa-file-export"></i> Export</button>
                </h3>
                <div class="filter-bar">
                    <input type="text" id="orderSearch" placeholder="Search customer..." oninput="renderOrders()">
                    <select id="orderFilter" onchange="renderOrders()">
                        <option value="pending">Active Only</option>
                        <option value="delivered">Archive</option>
                        <option value="bulk">Bulk Orders Only</option>
                        <option value="all">View All</option>
                    </select>
                </div>
                <div class="scroll-section" id="orders"></div>
            </div>

            <div>
                <h3 class="section-title">
                    <span><i class="fas fa-boxes"></i> Inventory</span>
                    <div style="display: flex; gap: 5px;">
                        <button class="bulk-adjust-btn" id="bulkAdjBtn" onclick="toggleBulkAdjust()"><i class="fas fa-edit"></i> Bulk Adjust</button>
                        <button class="bulk-save-btn" id="bulkSaveBtn" onclick="saveBulkChanges()"><i class="fas fa-check"></i> Save All</button>
                        <button class="btn-export" onclick="printRestockList()"><i class="fas fa-print"></i> Restock List</button>
                    </div>
                </h3>
                <div class="filter-bar">
                    <input type="text" id="invSearch" placeholder="Search products..." oninput="renderInventory()">
                    <select id="invCatFilter" onchange="renderInventory()">
                        <option value="all">All Categories</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Home">Home</option>
                        <option value="Beauty">Beauty</option>
                    </select>
                </div>
                <div class="scroll-section" id="inv"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwhyU5BrtjRhy-45rd5oYfzGO8abehUiM",
            authDomain: "shopeasy-14890.firebaseapp.com",
            projectId: "shopeasy-14890",
            storageBucket: "shopeasy-14890.firebasestorage.app",
            messagingSenderId: "45827037951",
            appId: "1:45827037951:web:545d41703780fa51018aca"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const ADMIN_EMAIL = "onganimwase1@gmail.com"; // <--- CHANGE THIS TO YOUR GMAIL

        let editId = null;
        let productsDataCache = {};
        let ordersDataCache = [];
        let initialLoad = true;
        let bulkMode = "none";

        // AUTHENTICATION LOGIC
        window.loginAdmin = () => {
            signInWithPopup(auth, provider).catch(err => alert(err.message));
        };

        window.logout = () => { if(confirm("Logout?")) { signOut(auth); } };

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
            } else {
                if (user) { 
                    alert("Unauthorized!"); 
                    signOut(auth);
                }
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('admin-dashboard').style.display = 'none';
            }
        });

        window.calcBulkFromPercent = () => {
            const price = Number(document.getElementById('price').value);
            const percent = Number(document.getElementById('bulkPercent').value);
            if(price && percent) {
                const bulkPrice = Math.round(price - (price * (percent / 100)));
                document.getElementById('bulkPrice').value = bulkPrice;
            }
        };

        window.toggleBulkPrice = () => {
            const isChecked = document.getElementById('bulkToggle').checked;
            const bPrice = document.getElementById('bulkPrice').value;
            if(isChecked && bPrice) { document.getElementById('price').value = bPrice; }
        };

        window.upload = async () => {
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const costPrice = document.getElementById('costPrice').value;
            const bPrice = document.getElementById('bulkPrice').value;
            const stock = document.getElementById('stock').value;
            const image = document.getElementById('img').value;
            const category = document.getElementById('cat').value;
            const desc = document.getElementById('desc').value;
            const aLevel = document.getElementById('alertLevel').value;

            if(!name || !price || !stock || !image) return alert("Fill required fields!");
            const data = { 
                name, price: Number(price), 
                costPrice: Number(costPrice) || 0, 
                bulkPrice: Number(bPrice) || Number(price), 
                stock: Number(stock), 
                alertLevel: Number(aLevel) || 3,
                image, category, description: desc || "No details." 
            };
            if (editId) { await updateDoc(doc(db, "products", editId), data); } 
            else { data.timestamp = Date.now(); await addDoc(collection(db, "products"), data); }
            resetForm();
        };

        window.startEdit = (id) => {
            const p = productsDataCache[id]; editId = id;
            document.getElementById('name').value = p.name; 
            document.getElementById('price').value = p.price;
            document.getElementById('costPrice').value = p.costPrice || 0; 
            document.getElementById('bulkPrice').value = p.bulkPrice || p.price;
            document.getElementById('stock').value = p.stock;
            document.getElementById('alertLevel').value = p.alertLevel || 3;
            document.getElementById('img').value = p.image; 
            document.getElementById('cat').value = p.category;
            document.getElementById('desc').value = p.description; 
            document.getElementById('formTitle').innerText = "âœï¸ Edit: " + p.name;
            document.getElementById('formCard').classList.add('edit-mode-active'); 
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo(0,0);
        };

        window.resetForm = () => {
            editId = null; document.querySelectorAll('#formCard input, #formCard textarea').forEach(i => i.value = "");
            document.getElementById('formTitle').innerText = "ðŸš€ Post New Product";
            document.getElementById('formCard').classList.remove('edit-mode-active'); 
            document.getElementById('cancelBtn').style.display = "none";
        };

        onSnapshot(query(collection(db, "products"), orderBy("timestamp", "desc")), snap => {
            productsDataCache = {}; 
            let alertCount = 0;
            snap.forEach(d => { 
                const data = d.data();
                productsDataCache[d.id] = { ...data, id: d.id }; 
                const threshold = data.alertLevel || 3;
                if(data.stock <= threshold) alertCount++;
            });
            const restockBtn = document.getElementById('restockBtn');
            if(alertCount > 0) {
                restockBtn.style.display = 'flex';
                document.getElementById('outCount').innerText = alertCount;
            } else { restockBtn.style.display = 'none'; }
            renderInventory(); calculateStats();
        });

        window.renderInventory = () => {
            const cont = document.getElementById('inv');
            const search = document.getElementById('invSearch').value.toLowerCase();
            const catFilter = document.getElementById('invCatFilter').value;
            cont.innerHTML = "";
            Object.values(productsDataCache).filter(p => {
                const matchSearch = p.name.toLowerCase().includes(search);
                const matchCat = catFilter === 'all' || p.category === catFilter;
                return matchSearch && matchCat;
            }).forEach(p => {
                const threshold = p.alertLevel || 3;
                const isLow = p.stock <= threshold && p.stock > 0; 
                const isWarning = p.stock > threshold && p.stock <= (threshold + 7);
                const isOut = p.stock <= 0;
                
                let controls = `<input type="number" class="stock-input" value="${p.stock}" onchange="updateStock('${p.id}', this.value)">`;
                
                if (bulkMode === "adjust") {
                    controls = `
                        <div style="display:flex; flex-direction:column; gap:2px;">
                            <input type="number" class="bulk-input-field bulk-price" placeholder="Price" data-id="${p.id}" value="${p.price}">
                            <input type="number" class="bulk-input-field bulk-bulk" placeholder="Bulk" data-id="${p.id}" value="${p.bulkPrice || p.price}">
                            <input type="number" class="bulk-input-field bulk-stock" placeholder="+Stock" data-id="${p.id}">
                        </div>`;
                }

                cont.innerHTML += `
                <div class="inv-item ${isOut || isLow ? 'low-stock' : (isWarning ? 'warning-stock' : '')}">
                    <img src="${p.image}" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="inv-info">
                        <b>${p.name} 
                           ${isOut ? '<span class="badge-sold">SOLD OUT</span>' : ''}
                           ${isLow && !isOut ? '<span class="badge-low">LOW</span>' : ''}
                        </b>
                        <small>P: MK ${p.price.toLocaleString()} | B: MK ${(p.bulkPrice || p.price).toLocaleString()} | S: ${p.stock}</small>
                    </div>
                    ${controls}
                    <div class="action-btns"><button class="btn-edit" onclick="startEdit('${p.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-del" onclick="del('${p.id}')"><i class="fas fa-trash"></i></button></div></div>`;
            });
        };

        window.toggleBulkAdjust = () => {
            bulkMode = (bulkMode === "none") ? "adjust" : "none";
            document.getElementById('bulkAdjBtn').innerText = (bulkMode === "none") ? "Bulk Adjust" : "Cancel Edit";
            document.getElementById('bulkSaveBtn').style.display = (bulkMode === "none") ? "none" : "block";
            renderInventory();
        };

        window.saveBulkChanges = async () => {
            const batch = writeBatch(db);
            let changesFound = false;

            document.querySelectorAll('.bulk-price').forEach(el => {
                const pId = el.dataset.id;
                const newPrice = Number(el.value);
                const newBulk = Number(document.querySelector(`.bulk-bulk[data-id="${pId}"]`).value);
                const addStock = Number(document.querySelector(`.bulk-stock[data-id="${pId}"]`).value) || 0;

                if (newPrice !== productsDataCache[pId].price || newBulk !== (productsDataCache[pId].bulkPrice || productsDataCache[pId].price) || addStock !== 0) {
                    batch.update(doc(db, "products", pId), {
                        price: newPrice,
                        bulkPrice: newBulk,
                        stock: productsDataCache[pId].stock + addStock
                    });
                    changesFound = true;
                }
            });

            if (changesFound) {
                await batch.commit();
                alert("Batch update successful!");
            }
            toggleBulkAdjust();
        };

        window.filterOutStock = () => {
            document.getElementById('invSearch').value = "";
            document.getElementById('invCatFilter').value = "all";
            const cont = document.getElementById('inv');
            cont.innerHTML = "";
            Object.values(productsDataCache).filter(p => p.stock <= (p.alertLevel || 3)).forEach(p => {
                cont.innerHTML += `
                <div class="inv-item low-stock">
                    <img src="${p.image}" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="inv-info"><b>${p.name} ${p.stock <= 0 ? '<span class="badge-sold">SOLD OUT</span>' : '<span class="badge-low">LOW</span>'}</b>
                    <small>MK ${p.price.toLocaleString()}</small></div>
                    <input type="number" class="stock-input" value="${p.stock}" onchange="updateStock('${p.id}', this.value)">
                    <div class="action-btns"><button class="btn-edit" onclick="startEdit('${p.id}')"><i class="fas fa-edit"></i></button></div></div>`;
            });
        };

        window.updateStock = async (id, val) => { await updateDoc(doc(db, "products", id), { stock: Number(val) }); };
        window.del = async (id) => { if(confirm("Remove?")) await deleteDoc(doc(db, "products", id)); };

        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), snap => {
            if (!initialLoad && snap.docs.length > ordersDataCache.length) { showNotification(); }
            ordersDataCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderOrders(); calculateStats(); initialLoad = false;
        });

        function showNotification() {
            const toast = document.getElementById('order-toast'); toast.style.display = 'block';
            const context = new AudioContext(); const osc = context.createOscillator();
            osc.connect(context.destination); osc.start(); osc.stop(context.currentTime + 0.1);
            setTimeout(() => { toast.style.display = 'none'; }, 5000);
        }

        window.renderOrders = () => {
            const cont = document.getElementById('orders'); const search = document.getElementById('orderSearch').value.toLowerCase();
            const filter = document.getElementById('orderFilter').value; cont.innerHTML = "";
            
            ordersDataCache.filter(o => {
                const matchSearch = o.customerName.toLowerCase().includes(search);
                let isBulkOrder = false;
                o.items.forEach(item => {
                    const pInfo = Object.values(productsDataCache).find(p => p.name === item.name);
                    if(pInfo && item.price === pInfo.bulkPrice) isBulkOrder = true;
                });
                let matchFilter = filter === 'all' || (filter === 'pending' && o.status !== 'delivered') || (filter === 'delivered' && o.status === 'delivered') || (filter === 'bulk' && isBulkOrder);
                return matchSearch && matchFilter;
            }).forEach(o => {
                const isDelivered = o.status === 'delivered';
                let isBulkOrder = false;
                o.items.forEach(item => {
                    const pInfo = Object.values(productsDataCache).find(p => p.name === item.name);
                    if(pInfo && item.price === pInfo.bulkPrice) isBulkOrder = true;
                });
                cont.innerHTML += `
                <div class="order ${isDelivered ? 'delivered' : ''}">
                    ${isBulkOrder ? '<span class="badge-bulk">BULK ORDER</span>' : ''}
                    <b>${o.customerName}</b> <small>${new Date(o.timestamp).toLocaleDateString()}</small>
                    <div style="color:var(--primary); font-weight:bold;">MK ${Number(o.total).toLocaleString()}</div>
                    <div style="font-size:12px;">${o.items.map(i => i.name + ' (x'+(i.qty||1)+')').join(", ")}</div>
                    ${!isDelivered ? `<button class="mark-btn" onclick="mark('${o.id}')">Mark Delivered</button>` : 'âœ… Archived'}</div>`;
            });
        };

        window.calculateStats = () => {
            let totalRev = 0; let totalProfit = 0; let counter = {};
            ordersDataCache.forEach(order => {
                totalRev += Number(order.total);
                order.items.forEach(item => {
                    counter[item.name] = (counter[item.name] || 0) + (item.qty || 1);
                    const pInfo = Object.values(productsDataCache).find(p => p.name === item.name);
                    const cost = pInfo ? (pInfo.costPrice || 0) : 0;
                    totalProfit += ((item.price || (pInfo?pInfo.price:0)) - cost) * (item.qty || 1);
                });
            });
            let topName = "None"; let max = 0;
            for (let n in counter) { if (counter[n] > max) { max = counter[n]; topName = n; } }
            document.getElementById('totalRevenue').innerText = "MK " + totalRev.toLocaleString();
            document.getElementById('totalProfit').innerText = "MK " + totalProfit.toLocaleString();
            document.getElementById('topProduct').innerText = topName;
        };

        window.showDailySummary = () => {
            const todayStr = new Date().toLocaleDateString();
            let dayRev = 0; let dayProf = 0;
            let outOfStockList = [];
            let lowStockList = [];
            ordersDataCache.filter(o => new Date(o.timestamp).toLocaleDateString() === todayStr).forEach(order => {
                dayRev += Number(order.total);
                order.items.forEach(item => {
                    const pInfo = Object.values(productsDataCache).find(p => p.name === item.name);
                    const cost = pInfo ? (pInfo.costPrice || 0) : 0;
                    dayProf += ((item.price || (pInfo?pInfo.price:0)) - cost) * (item.qty || 1);
                });
            });
            Object.values(productsDataCache).forEach(p => {
                const threshold = p.alertLevel || 3;
                if (p.stock <= 0) outOfStockList.push(p.name);
                else if (p.stock <= threshold) lowStockList.push(`${p.name} (${p.stock} left)`);
            });
            const summaryText = `--- TODAY'S SUMMARY (${todayStr}) ---
Revenue: MK ${dayRev.toLocaleString()}
Profit: MK ${dayProf.toLocaleString()}

--- REPLENISHMENT LIST ---
OUT: ${outOfStockList.join(", ") || "None"}
LOW: ${lowStockList.join(", ") || "None"}`;
            alert(summaryText);
        };

        window.printRestockList = () => {
            let list = Object.values(productsDataCache).filter(p => p.stock <= (p.alertLevel || 3));
            if(list.length === 0) return alert("All stocked up!");
            const printWin = window.open('', '_blank');
            printWin.document.write(`<html><head><title>Restock</title><style>body{font-family:sans-serif;padding:20px;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ddd;padding:12px;}</style></head><body onload="window.print()"><h2>Restock Checklist - ${new Date().toLocaleDateString()}</h2><table><tr><th>Item</th><th>Cat</th><th>Qty</th></tr>${list.map(p => `<tr><td>${p.name}</td><td>${p.category}</td><td>${p.stock}</td></tr>`).join('')}</table></body></html>`);
            printWin.document.close();
        };

        window.mark = async (id) => { await updateDoc(doc(db, "orders", id), { status: "delivered" }); };
        window.exportOrders = () => {
            let csv = "Date,Customer,Total\n";
            ordersDataCache.forEach(o => csv += `${new Date(o.timestamp).toLocaleDateString()},${o.customerName},${o.total}\n`);
            const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = "Sales.csv"; link.click();
        };
        window.clearOrders = async () => {
            if(confirm("Clear ALL?")) {
                const snap = await getDocs(query(collection(db, "orders")));
                const batch = writeBatch(db); snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
            }
        };
    </script>
</body>
</html>
