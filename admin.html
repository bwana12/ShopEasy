<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopEasy Admin | Inventory & Orders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #e42c64; --secondary: #2a9dcc; --dark: #1a1a1a; --success: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        header { background: var(--dark); color: white; padding: 20px; text-align: center; }

        .admin-container { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; flex-wrap: wrap; }
        
        .section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex: 1; min-width: 320px; overflow-y: auto; }
        h2 { font-size: 18px; margin-bottom: 15px; color: var(--dark); border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* Revenue Card */
        .revenue-card { background: var(--success); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; position: relative; }
        .revenue-card h1 { margin: 10px 0; font-size: 28px; }
        
        /* Clear Button Styling */
        .btn-clear { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; transition: 0.3s; }
        .btn-clear:hover { background: white; color: var(--success); }

        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        .btn-add { background: var(--primary); color: white; border: none; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .item-info b { display: block; font-size: 14px; }
        .item-info small { color: #888; }
        .stock-control { display: flex; align-items: center; gap: 10px; }
        .stock-input { width: 60px; margin-bottom: 0; text-align: center; padding: 5px; }
        .btn-del { color: #ff4d4d; border: none; background: none; cursor: pointer; font-size: 18px; }

        .order-card { background: #fff; border-left: 5px solid var(--secondary); padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .order-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>

    <header>
        <h1>ShopEasy Admin Panel</h1>
        <p>Real-time Business Management</p>
    </header>

    <div class="admin-container">
        
        <div style="flex: 1; min-width: 320px; display: flex; flex-direction: column; gap: 20px;">
            <div class="section" style="flex: none;">
                <h2>
                    <span><i class="fas fa-chart-line"></i> Total Revenue</span>
                    <button class="btn-clear" onclick="clearOrders()"><i class="fas fa-eraser"></i> Clear Orders</button>
                </h2>
                <div class="revenue-card">
                    <p>Estimated Earnings</p>
                    <h1 id="totalRevenue">MK 0</h1>
                    <small id="orderCount">0 Orders Processed</small>
                </div>
            </div>

            <div class="section">
                <h2><i class="fas fa-plus-circle"></i> Add New Product</h2>
                <form id="productForm">
                    <input type="text" id="pName" placeholder="Product Name" required>
                    <input type="number" id="pPrice" placeholder="Price (MK)" required>
                    <input type="number" id="pStock" placeholder="Initial Stock Quantity" required>
                    <select id="pCategory">
                        <option value="Electronics">Electronics</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Home">Home</option>
                        <option value="Beauty">Beauty</option>
                    </select>
                    <input type="text" id="pImage" placeholder="Image URL" required>
                    <textarea id="pDesc" placeholder="Product Description" rows="3"></textarea>
                    <button type="submit" class="btn-add">Upload Product</button>
                </form>
            </div>
        </div>

        <div class="section">
            <h2><i class="fas fa-boxes"></i> Inventory (Stock)</h2>
            <div id="inventoryList"></div>
        </div>

        <div class="section">
            <h2><i class="fas fa-shopping-bag"></i> Customer Orders</h2>
            <div id="ordersList"></div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwhyU5BrtjRhy-45rd5oYfzGO8abehUiM",
            authDomain: "shopeasy-14890.firebaseapp.com",
            projectId: "shopeasy-14890",
            storageBucket: "shopeasy-14890.firebasestorage.app",
            messagingSenderId: "45827037951",
            appId: "1:45827037951:web:545d41703780fa51018aca"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- PRODUCT MANAGEMENT ---
        const productForm = document.getElementById('productForm');
        productForm.onsubmit = async (e) => {
            e.preventDefault();
            const newProduct = {
                name: document.getElementById('pName').value,
                price: Number(document.getElementById('pPrice').value),
                stock: Number(document.getElementById('pStock').value),
                category: document.getElementById('pCategory').value,
                image: document.getElementById('pImage').value,
                description: document.getElementById('pDesc').value,
                timestamp: Date.now()
            };
            try {
                await addDoc(collection(db, "products"), newProduct);
                alert("Product Added!");
                productForm.reset();
            } catch (err) { alert(err.message); }
        };

        // --- RENDER INVENTORY ---
        onSnapshot(query(collection(db, "products"), orderBy("timestamp", "desc")), (snap) => {
            const list = document.getElementById('inventoryList');
            list.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `
                    <div class="item-info">
                        <b>${p.name}</b>
                        <small>MK ${p.price.toLocaleString()} | ${p.category}</small>
                    </div>
                    <div class="stock-control">
                        <input type="number" class="stock-input" value="${p.stock}" 
                            onchange="updateStock('${d.id}', this.value)">
                        <button class="btn-del" onclick="deleteProduct('${d.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
                list.appendChild(row);
            });
        });

        window.updateStock = async (id, newStock) => {
            await updateDoc(doc(db, "products", id), { stock: Number(newStock) });
        };

        window.deleteProduct = async (id) => {
            if(confirm("Delete product?")) await deleteDoc(doc(db, "products", id));
        };

        // --- CLEAR ORDERS FUNCTION ---
        window.clearOrders = async () => {
            if(confirm("Are you sure? This will delete all order history and reset revenue to zero!")) {
                const q = query(collection(db, "orders"));
                const querySnapshot = await getDocs(q);
                const batch = writeBatch(db);
                querySnapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                alert("Order history cleared.");
            }
        };

        // --- RENDER ORDERS & REVENUE ---
        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snap) => {
            const list = document.getElementById('ordersList');
            let totalRevenue = 0;
            let orderCount = 0;
            list.innerHTML = "";
            
            snap.forEach(d => {
                const o = d.data();
                totalRevenue += Number(o.total);
                orderCount++;

                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <span class="order-status pending">${o.status.toUpperCase()}</span>
                    <p style="margin-top:5px;"><strong>Customer:</strong> ${o.customerName}</p>
                    <p><strong>Total:</strong> MK ${o.total.toLocaleString()}</p>
                    <small>${new Date(o.timestamp).toLocaleString()}</small>
                `;
                list.appendChild(card);
            });

            document.getElementById('totalRevenue').innerText = `MK ${totalRevenue.toLocaleString()}`;
            document.getElementById('orderCount').innerText = `${orderCount} Orders Processed`;
        });
    </script>
</body>
</html>
