<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopEasy | Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #e42c64; --secondary: #2a9dcc; --bg: #f0f2f5; --success: #28a745; --danger: #dc3545; }
        * { box-sizing: border-box; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; padding: 20px; color: #333; margin: 0; }
        
        /* Login Screen Overlay */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px;
        }
        .login-card .logo { font-size: 28px; font-weight: bold; color: var(--primary); margin-bottom: 20px; }
        .login-card input { margin-bottom: 15px; text-align: center; }

        /* Order Notification Toast */
        #order-toast {
            position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white;
            padding: 15px 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none; z-index: 10000; animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Dashboard Header */
        header { max-width: 1200px; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: stretch; flex-wrap: wrap; gap: 15px; }
        
        /* Revenue & Profit Cards */
        .stats-container { display: flex; gap: 15px; flex-grow: 1; flex-wrap: wrap; align-items: flex-start; }
        .stat-card { color: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex: 1; min-width: 200px; text-align: center; position: relative; }
        .rev-bg { background: var(--success); }
        .prof-bg { background: var(--secondary); }
        .best-bg { background: #6f42c1; }
        .stat-card h1 { margin: 5px 0; font-size: 22px; }
        .btn-clear { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; margin-top: 5px; }
        
        .btn-summary { background: #f39c12; color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px; height: fit-content; align-self: center; }
        
        /* Restock Alert Style */
        .restock-alert { background: var(--danger); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; display: none; align-items: center; gap: 8px; height: fit-content; align-self: center; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .btn-logout { background: white; color: var(--danger); border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 8px; height: fit-content; align-self: center; }
        .btn-export { background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; color: #444; }
        
        /* Admin Form Card */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--secondary); margin-bottom: 30px; transition: 0.3s; }
        .edit-mode-active { border-top-color: var(--primary); background: #fffdfd; }
        h2 { margin-bottom: 20px; font-size: 1.2rem; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .btn-post { background: var(--secondary); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-cancel { background: #666; color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; margin-top: 10px; font-size: 14px; display: none; }

        .bulk-toggle-container { display: flex; align-items: center; gap: 10px; margin: 10px 0; font-size: 14px; font-weight: bold; color: var(--secondary); }
        .bulk-toggle-container input { width: auto; margin: 0; }

        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1200px; margin: 0 auto; }
        @media (max-width: 850px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .filter-bar input { margin: 0; padding: 8px 12px; }

        .scroll-section { max-height: 700px; overflow-y: auto; padding-right: 10px; }
        .section-title { margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }

        /* Inventory Items */
        .inv-item { background: white; display: flex; align-items: center; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; gap: 15px; transition: 0.3s; }
        .low-stock { border-left: 5px solid var(--danger); background: #fff5f5; }
        .out-of-stock { opacity: 0.7; filter: grayscale(1); }
        .inv-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; }
        .inv-info { flex-grow: 1; }
        .inv-info b { font-size: 14px; display: block; }
        .stock-input { width: 70px !important; margin: 0 !important; padding: 5px !important; text-align: center; font-weight: bold; border-color: var(--secondary); }
        .margin-badge { color: var(--success); font-weight: bold; font-size: 11px; margin-left: 5px; }

        /* Orders */
        .order { background: white; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--secondary); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .delivered { opacity: 0.7; border-left-color: #888; background: #f9f9f9; border-left-style: dashed; }
        .badge-bulk { background: #6f42c1; color: white; font-size: 10px; padding: 3px 8px; border-radius: 5px; position: absolute; top: 10px; right: 10px; font-weight: bold; }
        .mark-btn { background: #25D366; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 10px; }
        
        .action-btns { display: flex; gap: 10px; }
        .btn-del { color: #ff4d4d; border: none; background: none; cursor: pointer; font-size: 16px; }
        .btn-edit { color: var(--secondary); border: none; background: none; cursor: pointer; font-size: 16px; }

        .row-flex { display: flex; gap: 10px; }
        .badge-low { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .badge-sold { background: #333; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="order-toast"><i class="fas fa-bell"></i> ðŸ”” New Order Received!</div>

    <div id="login-screen">
        <div class="login-card">
            <div class="logo">ShopEasy Admin</div>
            <input type="password" id="admin-pass" placeholder="Password">
            <button class="btn-post" onclick="checkLogin()">Login</button>
            <p id="login-error" style="color:var(--danger); font-size:12px; margin-top:10px; display:none;">Incorrect Password!</p>
        </div>
    </div>

    <div id="admin-dashboard" style="display: none;">
        <header>
            <div class="stats-container">
                <div class="stat-card rev-bg">
                    <p style="margin:0; font-size: 11px; opacity: 0.9;">TOTAL SALES</p>
                    <h1 id="totalRevenue">MK 0</h1>
                    <button class="btn-clear" onclick="clearOrders()"><i class="fas fa-eraser"></i> Reset</button>
                </div>
                <div class="stat-card prof-bg">
                    <p style="margin:0; font-size: 11px; opacity: 0.9;">EST. PROFIT</p>
                    <h1 id="totalProfit">MK 0</h1>
                </div>
                <div class="stat-card best-bg">
                    <p style="margin:0; font-size: 11px; opacity: 0.9;">TOP SELLER</p>
                    <h1 id="topProduct" style="font-size: 16px; margin-top: 8px;">None</h1>
                </div>
                <button class="restock-alert" id="restockBtn" onclick="filterOutStock()"><i class="fas fa-exclamation-triangle"></i> <span id="outCount">0</span> Out of Stock</button>
                <button class="btn-summary" onclick="showDailySummary()"><i class="fas fa-calendar-day"></i> Today</button>
                <button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <div class="dashboard-grid">
            <div>
                <div class="card" id="formCard">
                    <h2 id="formTitle">ðŸš€ Post New Product</h2>
                    <input type="text" id="name" placeholder="Product Name">
                    <div class="bulk-toggle-container">
                        <input type="checkbox" id="bulkToggle" onchange="toggleBulkPrice()"> 
                        <label for="bulkToggle">Apply Bulk Price to Sale Price?</label>
                    </div>
                    <div class="row-flex">
                        <input type="number" id="price" placeholder="Sale Price (MK)">
                        <input type="number" id="costPrice" placeholder="Cost Price (MK)">
                    </div>
                    <div class="row-flex">
                        <input type="number" id="bulkPrice" placeholder="Bulk Price (MK)">
                        <input type="number" id="stock" placeholder="Stock Qty">
                    </div>
                    <select id="cat">
                        <option value="Electronics">Electronics</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Home">Home</option>
                        <option value="Beauty">Beauty</option>
                    </select>
                    <input type="text" id="img" placeholder="Image Link">
                    <textarea id="desc" placeholder="Details..."></textarea>
                    <button class="btn-post" id="submitBtn" onclick="upload()">Publish Product</button>
                    <button class="btn-cancel" id="cancelBtn" onclick="resetForm()">Cancel Editing</button>
                </div>

                <h3 class="section-title">
                    <span><i class="fas fa-shopping-bag"></i> Orders</span>
                    <button class="btn-export" onclick="exportOrders()"><i class="fas fa-file-export"></i> Export</button>
                </h3>
                <div class="filter-bar">
                    <input type="text" id="orderSearch" placeholder="Search customer..." oninput="renderOrders()">
                    <select id="orderFilter" onchange="renderOrders()">
                        <option value="pending">Active Only</option>
                        <option value="delivered">Archive</option>
                        <option value="bulk">Bulk Orders Only</option>
                        <option value="all">View All</option>
                    </select>
                </div>
                <div class="scroll-section" id="orders"></div>
            </div>

            <div>
                <h3 class="section-title"><span><i class="fas fa-boxes"></i> Inventory</span></h3>
                <div class="filter-bar">
                    <input type="text" id="invSearch" placeholder="Search products..." oninput="renderInventory()">
                    <select id="invCatFilter" onchange="renderInventory()">
                        <option value="all">All Categories</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Home">Home</option>
                        <option value="Beauty">Beauty</option>
                    </select>
                </div>
                <div class="scroll-section" id="inv"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwhyU5BrtjRhy-45rd5oYfzGO8abehUiM",
            authDomain: "shopeasy-14890.firebaseapp.com",
            projectId: "shopeasy-14890",
            storageBucket: "shopeasy-14890.firebasestorage.app",
            messagingSenderId: "45827037951",
            appId: "1:45827037951:web:545d41703780fa51018aca"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let editId = null;
        let productsDataCache = {};
        let ordersDataCache = [];
        let initialLoad = true;

        window.checkLogin = () => {
            const pass = document.getElementById('admin-pass').value;
            if(pass === "@bwanamwase1") {
                sessionStorage.setItem("auth", "ok");
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('admin-dashboard').style.display = 'block';
            } else { document.getElementById('login-error').style.display = 'block'; }
        }

        window.logout = () => { if(confirm("Logout?")) { sessionStorage.removeItem("auth"); window.location.reload(); } }
        if(sessionStorage.getItem("auth") === "ok"){
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
        }

        window.toggleBulkPrice = () => {
            const isChecked = document.getElementById('bulkToggle').checked;
            const bPrice = document.getElementById('bulkPrice').value;
            if(isChecked && bPrice) { document.getElementById('price').value = bPrice; }
        };

        window.upload = async () => {
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const costPrice = document.getElementById('costPrice').value;
            const bPrice = document.getElementById('bulkPrice').value;
            const stock = document.getElementById('stock').value;
            const image = document.getElementById('img').value;
            const category = document.getElementById('cat').value;
            const desc = document.getElementById('desc').value;

            if(!name || !price || !stock || !image) return alert("Fill required fields!");
            const data = { name, price: Number(price), costPrice: Number(costPrice) || 0, bulkPrice: Number(bPrice) || Number(price), stock: Number(stock), image, category, description: desc || "No details." };
            if (editId) { await updateDoc(doc(db, "products", editId), data); } 
            else { data.timestamp = Date.now(); await addDoc(collection(db, "products"), data); }
            resetForm();
        };

        window.startEdit = (id) => {
            const p = productsDataCache[id]; editId = id;
            document.getElementById('name').value = p.name; document.getElementById('price').value = p.price;
            document.getElementById('costPrice').value = p.costPrice || 0; 
            document.getElementById('bulkPrice').value = p.bulkPrice || p.price;
            document.getElementById('stock').value = p.stock;
            document.getElementById('img').value = p.image; document.getElementById('cat').value = p.category;
            document.getElementById('desc').value = p.description; document.getElementById('formTitle').innerText = "âœï¸ Edit: " + p.name;
            document.getElementById('formCard').classList.add('edit-mode-active'); document.getElementById('cancelBtn').style.display = "block";
            document.getElementById('bulkToggle').checked = false;
            window.scrollTo(0,0);
        };

        window.resetForm = () => {
            editId = null; document.querySelectorAll('#formCard input, #formCard textarea').forEach(i => i.value = "");
            document.getElementById('formTitle').innerText = "ðŸš€ Post New Product";
            document.getElementById('formCard').classList.remove('edit-mode-active'); document.getElementById('cancelBtn').style.display = "none";
            document.getElementById('bulkToggle').checked = false;
        };

        onSnapshot(query(collection(db, "products"), orderBy("timestamp", "desc")), snap => {
            productsDataCache = {}; 
            let outCount = 0;
            snap.forEach(d => { 
                const data = d.data();
                productsDataCache[d.id] = { ...data, id: d.id }; 
                if(data.stock <= 0) outCount++;
            });
            const restockBtn = document.getElementById('restockBtn');
            if(outCount > 0) {
                restockBtn.style.display = 'flex';
                document.getElementById('outCount').innerText = outCount;
            } else { restockBtn.style.display = 'none'; }
            renderInventory(); calculateStats();
        });

        window.renderInventory = () => {
            const cont = document.getElementById('inv');
            const search = document.getElementById('invSearch').value.toLowerCase();
            const catFilter = document.getElementById('invCatFilter').value;
            cont.innerHTML = "";
            Object.values(productsDataCache).filter(p => {
                const matchSearch = p.name.toLowerCase().includes(search);
                const matchCat = catFilter === 'all' || p.category === catFilter;
                return matchSearch && matchCat;
            }).forEach(p => {
                const isLow = p.stock <= 3 && p.stock > 0; const isOut = p.stock <= 0;
                const margin = p.price > 0 ? Math.round(((p.price - (p.costPrice || 0)) / p.price) * 100) : 0;
                
                cont.innerHTML += `
                <div class="inv-item ${isOut ? 'out-of-stock' : (isLow ? 'low-stock' : '')}">
                    <img src="${p.image}" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="inv-info"><b>${p.name} ${isOut ? '<span class="badge-sold">SOLD OUT</span>' : (isLow ? '<span class="badge-low">LOW</span>' : '')}</b>
                    <small>MK ${p.price.toLocaleString()} | Cost: ${p.costPrice} <span class="margin-badge">(${margin}% margin)</span></small></div>
                    <input type="number" class="stock-input" value="${p.stock}" onchange="updateStock('${p.id}', this.value)">
                    <div class="action-btns"><button class="btn-edit" onclick="startEdit('${p.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-del" onclick="del('${p.id}')"><i class="fas fa-trash"></i></button></div></div>`;
            });
        };

        window.filterOutStock = () => {
            document.getElementById('invSearch').value = "";
            document.getElementById('invCatFilter').value = "all";
            const cont = document.getElementById('inv');
            cont.innerHTML = "";
            Object.values(productsDataCache).filter(p => p.stock <= 0).forEach(p => {
                cont.innerHTML += `
                <div class="inv-item out-of-stock">
                    <img src="${p.image}" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="inv-info"><b>${p.name} <span class="badge-sold">SOLD OUT</span></b>
                    <small>MK ${p.price.toLocaleString()}</small></div>
                    <input type="number" class="stock-input" value="${p.stock}" onchange="updateStock('${p.id}', this.value)">
                    <div class="action-btns"><button class="btn-edit" onclick="startEdit('${p.id}')"><i class="fas fa-edit"></i></button></div></div>`;
            });
        };

        window.updateStock = async (id, val) => { await updateDoc(doc(db, "products", id), { stock: Number(val) }); };
        window.del = async (id) => { if(confirm("Remove?")) await deleteDoc(doc(db, "products", id)); };

        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), snap => {
            if (!initialLoad && snap.docs.length > ordersDataCache.length) { showNotification(); }
            ordersDataCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderOrders(); calculateStats(); initialLoad = false;
        });

        function showNotification() {
            const toast = document.getElementById('order-toast'); toast.style.display = 'block';
            const context = new AudioContext(); const osc = context.createOscillator();
            osc.connect(context.destination); osc.start(); osc.stop(context.currentTime + 0.1);
            setTimeout(() => { toast.style.display = 'none'; }, 5000);
        }

        window.renderOrders = () => {
            const cont = document.getElementById('orders'); const search = document.getElementById('orderSearch').value.toLowerCase();
            const filter = document.getElementById('orderFilter').value; cont.innerHTML = "";
            
            ordersDataCache.filter(o => {
                const matchSearch = o.customerName.toLowerCase().includes(search);
                let isBulkOrder = false;
                o.items.forEach(item => {
                    const pInfo = Object.values(productsDataCache).find(p => p.name === item.name);
                    if(pInfo && item.price === pInfo.bulkPrice) isBulkOrder = true;
                });
                let matchFilter = filter === 'all' || (filter === 'pending' && o.status !== 'delivered') || (filter === 'delivered' && o.status === 'delivered') || (filter === 'bulk' && isBulkOrder);
                return matchSearch && matchFilter;
            }).forEach(o => {
                const isDelivered = o.status === 'delivered';
                let isBulkOrder = false;
                o.items.forEach(item => {
                    const pInfo = Object.values(productsDataCache).find(p => p.name === item.name);
                    if(pInfo && item.price === pInfo.bulkPrice) isBulkOrder = true;
                });
                cont.innerHTML += `
                <div class="order ${isDelivered ? 'delivered' : ''}">
                    ${isBulkOrder ? '<span class="badge-bulk">BULK ORDER</span>' : ''}
                    <b>${o.customerName}</b> <small>${new Date(o.timestamp).toLocaleDateString()}</small>
                    <div style="color:var(--primary); font-weight:bold;">MK ${Number(o.total).toLocaleString()}</div>
                    <div style="font-size:12px;">${o.items.map(i => i.name + ' (x'+(i.qty||1)+')').join(", ")}</div>
                    ${!isDelivered ? `<button class="mark-btn" onclick="mark('${o.id}')">Mark Delivered</button>` : 'âœ… Archived'}</div>`;
            });
        };

        window.calculateStats = () => {
            let totalRev = 0; let totalProfit = 0; let counter = {};
            ordersDataCache.forEach(order => {
                totalRev += Number(order.total);
                order.items.forEach(item => {
                    counter[item.name] = (counter[item.name] || 0) + (item.qty || 1);
                    const pInfo = Object.values(productsDataCache).find(p => p.name === item.name);
                    const cost = pInfo ? (pInfo.costPrice || 0) : 0;
                    totalProfit += ((item.price || (pInfo?pInfo.price:0)) - cost) * (item.qty || 1);
                });
            });
            let topName = "None"; let max = 0;
            for (let n in counter) { if (counter[n] > max) { max = counter[n]; topName = n; } }
            document.getElementById('totalRevenue').innerText = "MK " + totalRev.toLocaleString();
            document.getElementById('totalProfit').innerText = "MK " + totalProfit.toLocaleString();
            document.getElementById('topProduct').innerText = topName;
        };

        window.showDailySummary = () => {
            const todayStr = new Date().toLocaleDateString();
            let dayRev = 0; let dayProf = 0;
            ordersDataCache.filter(o => new Date(o.timestamp).toLocaleDateString() === todayStr).forEach(order => {
                dayRev += Number(order.total);
                order.items.forEach(item => {
                    const pInfo = Object.values(productsDataCache).find(p => p.name === item.name);
                    const cost = pInfo ? (pInfo.costPrice || 0) : 0;
                    dayProf += ((item.price || (pInfo?pInfo.price:0)) - cost) * (item.qty || 1);
                });
            });
            alert(`--- TODAY'S SUMMARY (${todayStr}) ---\nRevenue: MK ${dayRev.toLocaleString()}\nProfit: MK ${dayProf.toLocaleString()}`);
        };

        window.mark = async (id) => { await updateDoc(doc(db, "orders", id), { status: "delivered" }); };
        window.exportOrders = () => {
            let csv = "Date,Customer,Items,Total\n";
            ordersDataCache.forEach(o => csv += `${new Date(o.timestamp).toLocaleDateString()},${o.customerName},${o.items.map(i=>i.name).join("|")},${o.total}\n`);
            const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = "Sales_Report.csv"; link.click();
        };
        window.clearOrders = async () => {
            if(confirm("Clear ALL?")) {
                const snap = await getDocs(query(collection(db, "orders")));
                const batch = writeBatch(db); snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
            }
        };
    </script>
</body>
</html>
