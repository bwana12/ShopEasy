<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopEasy | Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #e42c64; --secondary: #2a9dcc; --bg: #f0f2f5; --success: #28a745; }
        * { box-sizing: border-box; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; padding: 20px; color: #333; margin: 0; }
        
        /* Dashboard Header */
        header { max-width: 1000px; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        /* Revenue Card */
        .revenue-card { background: var(--success); color: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-grow: 1; min-width: 280px; text-align: center; }
        .revenue-card h1 { margin: 5px 0; font-size: 24px; }
        .btn-clear { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; margin-top: 5px; }

        /* Admin Form Card */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--secondary); margin-bottom: 30px; }
        h2 { margin-bottom: 20px; font-size: 1.2rem; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .btn-post { background: var(--secondary); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }

        /* Layout Grid */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1200px; margin: 0 auto; }
        @media (max-width: 850px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* Inventory & Orders Containers */
        .scroll-section { max-height: 700px; overflow-y: auto; padding-right: 10px; }
        .section-title { margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px; }

        /* Inventory Items */
        .inv-item { background: white; display: flex; align-items: center; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; gap: 15px; }
        .inv-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; }
        .inv-info { flex-grow: 1; }
        .inv-info b { font-size: 14px; display: block; }
        .stock-input { width: 70px !important; margin: 0 !important; padding: 5px !important; text-align: center; }

        /* Orders */
        .order { background: white; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--secondary); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .delivered { opacity: 0.6; border-left-color: #888; background: #f9f9f9; }
        .mark-btn { background: #25D366; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 10px; }
        
        .btn-del { color: #ff4d4d; border: none; background: none; cursor: pointer; font-size: 16px; }

        .row-flex { display: flex; gap: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="revenue-card">
            <p style="margin:0; font-size: 13px; opacity: 0.9;">TOTAL EARNINGS</p>
            <h1 id="totalRevenue">MK 0</h1>
            <button class="btn-clear" onclick="clearOrders()"><i class="fas fa-eraser"></i> Reset Order History</button>
        </div>
    </header>

    <div class="dashboard-grid">
        <div>
            <div class="card">
                <h2>ðŸš€ Post New Product</h2>
                <input type="text" id="name" placeholder="Product Name">
                
                <div class="row-flex">
                    <input type="number" id="price" placeholder="Normal Price (MK)">
                    <input type="number" id="bulkPrice" placeholder="Bulk Price (MK)">
                </div>
                
                <div class="row-flex">
                    <input type="number" id="stock" placeholder="Stock Qty">
                    <select id="cat">
                        <option value="Electronics">Electronics</option>
                        <option value="Fashion">Fashion</option>
                        <option value="Home">Home</option>
                        <option value="Beauty">Beauty</option>
                    </select>
                </div>

                <input type="text" id="img" placeholder="Image Link (https://...)">
                <textarea id="desc" placeholder="Product Details..."></textarea>
                <button class="btn-post" onclick="upload()">Publish Product</button>
            </div>

            <h3 class="section-title"><i class="fas fa-shopping-bag"></i> Customer Orders</h3>
            <div class="scroll-section" id="orders"></div>
        </div>

        <div>
            <h3 class="section-title"><i class="fas fa-boxes"></i> Inventory & Stock</h3>
            <div class="scroll-section" id="inv"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwhyU5BrtjRhy-45rd5oYfzGO8abehUiM",
            authDomain: "shopeasy-14890.firebaseapp.com",
            projectId: "shopeasy-14890",
            storageBucket: "shopeasy-14890.firebasestorage.app",
            messagingSenderId: "45827037951",
            appId: "1:45827037951:web:545d41703780fa51018aca"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Security Login
        if(sessionStorage.getItem("auth") !== "ok"){
            const pass = prompt("Admin Password:");
            if(pass === "admin123") sessionStorage.setItem("auth", "ok");
            else window.location.href = "index.html";
        }

        window.upload = async () => {
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const bPrice = document.getElementById('bulkPrice').value;
            const stock = document.getElementById('stock').value;
            const image = document.getElementById('img').value;
            const category = document.getElementById('cat').value;
            const desc = document.getElementById('desc').value;

            if(!name || !price || !stock || !image) return alert("Fill all main fields!");
            
            try {
                await addDoc(collection(db, "products"), {
                    name, 
                    price: Number(price), 
                    bulkPrice: Number(bPrice) || Number(price),
                    stock: Number(stock), 
                    image, 
                    category,
                    description: desc || "No details provided.", 
                    timestamp: Date.now()
                });
                alert("Product is Live!");
                document.getElementById('name').value = ""; 
                document.getElementById('price').value = "";
                document.getElementById('bulkPrice').value = "";
                document.getElementById('stock').value = ""; 
                document.getElementById('img').value = "";
            } catch (e) { alert(e.message); }
        };

        // Inventory & Stock Live
        onSnapshot(query(collection(db, "products"), orderBy("timestamp", "desc")), snap => {
            const cont = document.getElementById('inv');
            cont.innerHTML = "";
            snap.forEach(d => {
                const p = d.data();
                cont.innerHTML += `
                <div class="inv-item">
                    <img src="${p.image}" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="inv-info">
                        <b>${p.name}</b>
                        <small>Reg: MK ${p.price.toLocaleString()} | Bulk: MK ${p.bulkPrice ? p.bulkPrice.toLocaleString() : 'N/A'}</small>
                    </div>
                    <input type="number" class="stock-input" value="${p.stock}" onchange="updateStock('${d.id}', this.value)">
                    <button class="btn-del" onclick="del('${d.id}')"><i class="fas fa-trash"></i></button>
                </div>`;
            });
        });

        window.updateStock = async (id, val) => {
            await updateDoc(doc(db, "products", id), { stock: Number(val) });
        };

        window.del = async (id) => { 
            if(confirm("Remove this product?")) await deleteDoc(doc(db, "products", id));
        };

        // Orders & Revenue
        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), snap => {
            const cont = document.getElementById('orders');
            let rev = 0;
            cont.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                rev += Number(o.total);
                cont.innerHTML += `
                <div class="order ${o.status === 'delivered' ? 'delivered' : ''}">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${o.customerName}</b>
                        <small>${new Date(o.timestamp).toLocaleDateString()}</small>
                    </div>
                    <div style="font-size:13px; color:var(--primary); font-weight:bold; margin:5px 0;">MK ${Number(o.total).toLocaleString()}</div>
                    <div style="font-size:12px; color:#666;">${o.items.map(i => i.name + ' (x'+(i.qty||1)+')').join(", ")}</div>
                    ${o.status !== 'delivered' ? `<button class="mark-btn" onclick="mark('${d.id}')">Mark Delivered</button>` : '<div style="margin-top:10px; font-size:12px; color:green;">âœ… Completed</div>'}
                </div>`;
            });
            document.getElementById('totalRevenue').innerText = "MK " + rev.toLocaleString();
        });

        window.mark = async (id) => {
            await updateDoc(doc(db, "orders", id), { status: "delivered" });
        };

        window.clearOrders = async () => {
            if(confirm("Permanently delete ALL order history and reset revenue?")) {
                const q = query(collection(db, "orders"));
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
                alert("History Cleared.");
            }
        };
    </script>
</body>
</html>
