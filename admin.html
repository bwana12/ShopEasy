<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopEasy | Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #e42c64; --secondary: #2a9dcc; --bg: #f0f2f5; --success: #28a745; --danger: #dc3545; }
        * { box-sizing: border-box; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; padding: 20px; color: #333; margin: 0; }
        
        /* Dashboard Header */
        header { max-width: 1200px; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: stretch; flex-wrap: wrap; gap: 15px; }
        
        /* Revenue & Profit Cards */
        .stats-container { display: flex; gap: 15px; flex-grow: 1; flex-wrap: wrap; }
        .stat-card { color: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex: 1; min-width: 200px; text-align: center; }
        .rev-bg { background: var(--success); }
        .prof-bg { background: var(--secondary); }
        .stat-card h1 { margin: 5px 0; font-size: 22px; }
        .btn-clear { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer; margin-top: 5px; }

        /* Admin Form Card */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid var(--secondary); margin-bottom: 30px; transition: 0.3s; }
        .edit-mode-active { border-top-color: var(--primary); background: #fffdfd; }
        h2 { margin-bottom: 20px; font-size: 1.2rem; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; }
        .btn-post { background: var(--secondary); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-cancel { background: #666; color: white; border: none; padding: 10px; width: 100%; border-radius: 8px; cursor: pointer; margin-top: 10px; font-size: 14px; display: none; }

        /* Layout Grid */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1200px; margin: 0 auto; }
        @media (max-width: 850px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* Search & Filter Bar */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .filter-bar input { margin: 0; padding: 8px 12px; }

        /* Inventory & Orders Containers */
        .scroll-section { max-height: 700px; overflow-y: auto; padding-right: 10px; }
        .section-title { margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px; }

        /* Inventory Items */
        .inv-item { background: white; display: flex; align-items: center; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; gap: 15px; transition: 0.3s; }
        .low-stock { border-left: 5px solid var(--danger); background: #fff5f5; }
        .inv-item img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; }
        .inv-info { flex-grow: 1; }
        .inv-info b { font-size: 14px; display: block; }
        .stock-input { width: 70px !important; margin: 0 !important; padding: 5px !important; text-align: center; font-weight: bold; border-color: var(--secondary); }

        /* Orders */
        .order { background: white; padding: 15px; margin-bottom: 12px; border-left: 5px solid var(--secondary); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .delivered { opacity: 0.6; border-left-color: #888; background: #f9f9f9; }
        .mark-btn { background: #25D366; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 10px; }
        
        .action-btns { display: flex; gap: 10px; }
        .btn-del { color: #ff4d4d; border: none; background: none; cursor: pointer; font-size: 16px; }
        .btn-edit { color: var(--secondary); border: none; background: none; cursor: pointer; font-size: 16px; }

        .row-flex { display: flex; gap: 10px; }
        .badge-low { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
    </style>
</head>
<body>

    <header>
        <div class="stats-container">
            <div class="stat-card rev-bg">
                <p style="margin:0; font-size: 11px; opacity: 0.9;">TOTAL SALES</p>
                <h1 id="totalRevenue">MK 0</h1>
                <button class="btn-clear" onclick="clearOrders()"><i class="fas fa-eraser"></i> Reset</button>
            </div>
            <div class="stat-card prof-bg">
                <p style="margin:0; font-size: 11px; opacity: 0.9;">EST. PROFIT</p>
                <h1 id="totalProfit">MK 0</h1>
                <small style="font-size: 9px;">(Revenue - Cost Prices)</small>
            </div>
        </div>
    </header>

    <div class="dashboard-grid">
        <div>
            <div class="card" id="formCard">
                <h2 id="formTitle">ðŸš€ Post New Product</h2>
                <input type="text" id="name" placeholder="Product Name">
                
                <div class="row-flex">
                    <input type="number" id="price" placeholder="Sale Price (MK)">
                    <input type="number" id="costPrice" placeholder="Cost Price (MK) - For Profit">
                </div>
                
                <div class="row-flex">
                    <input type="number" id="bulkPrice" placeholder="Bulk Price (MK)">
                    <input type="number" id="stock" placeholder="Stock Qty">
                </div>
                
                <select id="cat">
                    <option value="Electronics">Electronics</option>
                    <option value="Fashion">Fashion</option>
                    <option value="Home">Home</option>
                    <option value="Beauty">Beauty</option>
                </select>

                <input type="text" id="img" placeholder="Image Link (https://...)">
                <textarea id="desc" placeholder="Product Details..."></textarea>
                <button class="btn-post" id="submitBtn" onclick="upload()">Publish Product</button>
                <button class="btn-cancel" id="cancelBtn" onclick="resetForm()">Cancel Editing</button>
            </div>

            <h3 class="section-title"><i class="fas fa-shopping-bag"></i> Customer Orders</h3>
            <div class="filter-bar">
                <input type="text" id="orderSearch" placeholder="Search by name..." oninput="renderOrders()">
                <select id="orderFilter" onchange="renderOrders()" style="width: 150px; margin:0;">
                    <option value="all">All Orders</option>
                    <option value="pending">Pending</option>
                    <option value="delivered">Delivered</option>
                </select>
            </div>
            <div class="scroll-section" id="orders"></div>
        </div>

        <div>
            <h3 class="section-title"><i class="fas fa-boxes"></i> Inventory & Stock</h3>
            <div class="scroll-section" id="inv"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwhyU5BrtjRhy-45rd5oYfzGO8abehUiM",
            authDomain: "shopeasy-14890.firebaseapp.com",
            projectId: "shopeasy-14890",
            storageBucket: "shopeasy-14890.firebasestorage.app",
            messagingSenderId: "45827037951",
            appId: "1:45827037951:web:545d41703780fa51018aca"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let editId = null;
        let productsDataCache = {};
        let ordersDataCache = [];

        // Security Login
        if(sessionStorage.getItem("auth") !== "ok"){
            const pass = prompt("Admin Password:");
            if(pass === "Shop2026") sessionStorage.setItem("auth", "ok");
            else window.location.href = "index.html";
        }

        window.upload = async () => {
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const costPrice = document.getElementById('costPrice').value;
            const bPrice = document.getElementById('bulkPrice').value;
            const stock = document.getElementById('stock').value;
            const image = document.getElementById('img').value;
            const category = document.getElementById('cat').value;
            const desc = document.getElementById('desc').value;

            if(!name || !price || !stock || !image) return alert("Fill all main fields!");
            
            try {
                const data = {
                    name, 
                    price: Number(price), 
                    costPrice: Number(costPrice) || 0,
                    bulkPrice: Number(bPrice) || Number(price),
                    stock: Number(stock), 
                    image, 
                    category,
                    description: desc || "No details provided."
                };

                if (editId) {
                    await updateDoc(doc(db, "products", editId), data);
                    alert("Product Updated!");
                } else {
                    data.timestamp = Date.now();
                    await addDoc(collection(db, "products"), data);
                    alert("Product is Live!");
                }
                resetForm();
            } catch (e) { alert(e.message); }
        };

        window.startEdit = (id) => {
            const p = productsDataCache[id];
            editId = id;
            document.getElementById('name').value = p.name;
            document.getElementById('price').value = p.price;
            document.getElementById('costPrice').value = p.costPrice || 0;
            document.getElementById('bulkPrice').value = p.bulkPrice || p.price;
            document.getElementById('stock').value = p.stock;
            document.getElementById('img').value = p.image;
            document.getElementById('cat').value = p.category;
            document.getElementById('desc').value = p.description;

            document.getElementById('formTitle').innerText = "âœï¸ Edit: " + p.name;
            document.getElementById('submitBtn').innerText = "Update Product";
            document.getElementById('formCard').classList.add('edit-mode-active');
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo(0,0);
        };

        window.resetForm = () => {
            editId = null;
            document.querySelectorAll('#formCard input, #formCard textarea').forEach(i => i.value = "");
            document.getElementById('formTitle').innerText = "ðŸš€ Post New Product";
            document.getElementById('submitBtn').innerText = "Publish Product";
            document.getElementById('formCard').classList.remove('edit-mode-active');
            document.getElementById('cancelBtn').style.display = "none";
        };

        // Inventory & Stock (Features: Low Stock Alert, Bulk Update)
        onSnapshot(query(collection(db, "products"), orderBy("timestamp", "desc")), snap => {
            const cont = document.getElementById('inv');
            cont.innerHTML = "";
            productsDataCache = {};
            snap.forEach(d => {
                const p = d.data();
                productsDataCache[d.id] = p;
                const isLow = p.stock <= 3;
                cont.innerHTML += `
                <div class="inv-item ${isLow ? 'low-stock' : ''}">
                    <img src="${p.image}" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="inv-info">
                        <b>${p.name} ${isLow ? '<span class="badge-low">LOW STOCK</span>' : ''}</b>
                        <small>Sale: MK ${p.price.toLocaleString()} | Cost: MK ${p.costPrice ? p.costPrice.toLocaleString() : '0'}</small>
                    </div>
                    <input type="number" class="stock-input" value="${p.stock}" onchange="updateStock('${d.id}', this.value)">
                    <div class="action-btns">
                        <button class="btn-edit" onclick="startEdit('${d.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn-del" onclick="del('${d.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
            calculateProfit();
        });

        window.updateStock = async (id, val) => {
            await updateDoc(doc(db, "products", id), { stock: Number(val) });
        };

        window.del = async (id) => { 
            if(confirm("Remove this product?")) await deleteDoc(doc(db, "products", id));
        };

        // Orders (Features: Search, Filter, Profit Calc)
        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), snap => {
            ordersDataCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderOrders();
            calculateProfit();
        });

        window.renderOrders = () => {
            const cont = document.getElementById('orders');
            const search = document.getElementById('orderSearch').value.toLowerCase();
            const filter = document.getElementById('orderFilter').value;
            
            cont.innerHTML = "";
            ordersDataCache.filter(o => {
                const matchSearch = o.customerName.toLowerCase().includes(search);
                const matchFilter = filter === 'all' || (filter === 'pending' && o.status !== 'delivered') || (filter === 'delivered' && o.status === 'delivered');
                return matchSearch && matchFilter;
            }).forEach(o => {
                cont.innerHTML += `
                <div class="order ${o.status === 'delivered' ? 'delivered' : ''}">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${o.customerName}</b>
                        <small>${new Date(o.timestamp).toLocaleDateString()}</small>
                    </div>
                    <div style="font-size:13px; color:var(--primary); font-weight:bold; margin:5px 0;">MK ${Number(o.total).toLocaleString()}</div>
                    <div style="font-size:12px; color:#666;">${o.items.map(i => i.name + ' (x'+(i.qty||1)+')').join(", ")}</div>
                    ${o.status !== 'delivered' ? `<button class="mark-btn" onclick="mark('${o.id}')">Mark Delivered</button>` : '<div style="margin-top:10px; font-size:12px; color:green;">âœ… Completed</div>'}
                </div>`;
            });
        };

        window.calculateProfit = () => {
            let totalRev = 0;
            let totalProfit = 0;

            ordersDataCache.forEach(order => {
                totalRev += Number(order.total);
                
                // Calculate profit for each item in order if we have cost data
                order.items.forEach(item => {
                    const productInfo = Object.values(productsDataCache).find(p => p.name === item.name);
                    const cost = productInfo ? (productInfo.costPrice || 0) : 0;
                    const pricePaid = item.price || (productInfo ? productInfo.price : 0);
                    totalProfit += (pricePaid - cost) * (item.qty || 1);
                });
            });

            document.getElementById('totalRevenue').innerText = "MK " + totalRev.toLocaleString();
            document.getElementById('totalProfit').innerText = "MK " + totalProfit.toLocaleString();
        };

        window.mark = async (id) => {
            await updateDoc(doc(db, "orders", id), { status: "delivered" });
        };

        window.clearOrders = async () => {
            if(confirm("Permanently delete ALL order history?")) {
                const q = query(collection(db, "orders"));
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                snap.forEach(d => batch.delete(d.ref));
                await batch.commit();
                alert("History Cleared.");
            }
        };
    </script>
</body>
</html>
